<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ å¥½è¯·åƒæˆ‘çš„ç•ªå‰§å®‰åˆ©</title>
    <style>
         :root {
            --primary-color: #3f51b5;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 900px;
        }
        
        #main-title-input {
            font-size: 24px;
            padding: 10px;
            margin: 10px 0;
            width: 80%;
            border: none;
            border-radius: 8px;
            text-align: center;
            outline: none;
            background: transparent;
        }
        /* ä¹å®«æ ¼å®¹å™¨ */
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }
        /* å¡ç‰‡æ ·å¼ */
        
        .card {
            position: relative;
            background: var(--card-bg);
            aspect-ratio: 2 / 3;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: visible;
            /* å…è®¸ä¸‹æ‹‰æ¡†æº¢å‡º */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s, transform 0.2s;
            z-index: 10;
        }
        
        .card:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn:hover {
            transform: scale(1.1);
            background-color: #ff3742;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        /* æ‹–æ‹½æ’åºæ ·å¼ */
        
        .card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .card.drag-over {
            border: 2px dashed var(--primary-color);
        }
        
        .card-image {
            flex: 1;
            background-color: #eee;
            background-size: cover;
            background-position: center;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 40px;
        }
        
        .card-title {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            background: white;
            border-radius: 0 0 12px 12px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #eee;
        }
        /* æœç´¢ä¸‹æ‹‰æ¡† */
        
        .search-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            margin-top: 5px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 10px;
            display: none;
        }
        /* ç¡®ä¿å¡ç‰‡å®¹å™¨ä¸ä¼šå½±å“æœç´¢æ¡†çš„å±‚çº§ */
        
        .card {
            position: relative;
            z-index: 1;
        }
        
        .search-container.active {
            display: block;
        }
        
        .search-input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .results-list {
            max-height: 160px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .result-item:hover {
            background: #f0f4ff;
        }
        
        .result-item img {
            width: 40px;
            height: 56px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        
        .result-item span {
            font-size: 13px;
            line-height: 1.4;
        }
        
        .loading-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 10px;
        }
        /* å“åº”å¼ */
        
        @media (max-width: 600px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            /* ç§»åŠ¨ç«¯4x3å¸ƒå±€è°ƒæ•´ */
            .grid-container[style*="repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px !important;
            }
            /* ç§»åŠ¨ç«¯5x2å¸ƒå±€è°ƒæ•´ */
            .grid-container[style*="repeat(5, 1fr)"] {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px !important;
            }
        }
        /* å°å±å¹•è°ƒæ•´ */
        
        @media (max-width: 400px) {
            /* å°å±å¹•4x3å¸ƒå±€è°ƒæ•´ */
            .grid-container[style*="repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px !important;
            }
            /* å°å±å¹•5x2å¸ƒå±€è°ƒæ•´ */
            .grid-container[style*="repeat(5, 1fr)"] {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px !important;
            }
        }
        /* æ·»åŠ ç•ªå‰§æŒ‰é’® */
        
        .add-anime-section {
            margin: 80px 0;
            width: 100%;
            max-width: 900px;
            text-align: center;
        }
        
        .add-anime-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .add-anime-btn:hover {
            background-color: #303f9f;
            transform: translateY(-2px);
        }
        
        .add-anime-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>

    <div class="header-section">
        <input type="text" id="main-title-input" placeholder="ç‚¹å‡»è¾“å…¥æ ‡é¢˜" />
    </div>

    <div class="grid-container" id="anime-grid">
        <!-- JS åŠ¨æ€ç”Ÿæˆ 9 ä¸ªå¡ç‰‡ -->
    </div>

    <div class="add-anime-section">
        <button class="add-anime-btn" id="add-anime-btn">æ·»åŠ ç•ªå‰§</button>
        <button class="add-anime-btn" id="screenshot-btn" style="margin-left: 10px;">æˆªå›¾ä¿å­˜</button>
        <select id="layout-select" style="margin-left: 10px; padding: 10px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 14px;">
            <option value="auto">è‡ªåŠ¨å¸ƒå±€</option>
            <option value="2x2">2x2å¸ƒå±€</option>
            <option value="3x3">3x3å¸ƒå±€</option>
            <option value="4x3">4x3å¸ƒå±€</option>
            <option value="5x2">5x2å¸ƒå±€</option>
        </select>
    </div>

    <script>
        // ==================== ä»£ç†é…ç½® ====================
        const PROXY_LIST = [
            'https://anime-image-proxy.morlvoid17.workers.dev/proxy?url=',
            'https://imgproxy.pcb.im/api/image-proxy?url='
        ];
        // é»˜è®¤ä½¿ç”¨
        let currentProxyIndex = 1;
        const IMAGE_PROXY = PROXY_LIST[currentProxyIndex];
        // å°†å›¾ç‰‡åœ°å€åŒ…è£…ä¸ºä»£ç†åœ°å€
        function proxyImage(url, proxyIndex = currentProxyIndex) {
            if (!url) return '';
            const proxyUrl = PROXY_LIST[proxyIndex];
            if (url.startsWith(proxyUrl) || url.startsWith('data:')) return url;
            return proxyUrl + encodeURIComponent(url);
        }
        // --- é…ç½®ä¸åˆå§‹æ•°æ® ---
        const LOCAL_PRESETS = [{
            title: "è¿›å‡»çš„å·¨äºº",
            image: "https://lain.bgm.tv/pic/cover/l/f5/66/216839_K777z.jpg"
        }, {
            title: "é’¢ä¹‹ç‚¼é‡‘æœ¯å¸ˆ FA",
            image: "https://lain.bgm.tv/pic/cover/l/c0/81/1482_f6696.jpg"
        }];
        // å¯¹æœ¬åœ°é¢„è®¾å›¾ç‰‡è¿›è¡Œä»£ç†åŒ…è£…
        LOCAL_PRESETS.forEach(item => {
            if (item.image) item.image = proxyImage(item.image);
        });
        let gridData = JSON.parse(localStorage.getItem('animeGridData')) || {
            mainTitle: "",
            cards: Array(9).fill(null).map(() => ({
                title: "ç‚¹å‡»é€‰æ‹©ç•ªå‰§",
                image: ""
            }))
        };
        // å…¨å±€é‡è¯•å‡½æ•°
        window.retryWithNextProxy = function(imgElement) {
            const originalUrl = imgElement.dataset.original;
            let retryCount = parseInt(imgElement.dataset.retry || 0);
            const maxRetries = PROXY_LIST.length;

            if (retryCount < maxRetries) {
                // å°è¯•ä¸‹ä¸€ä¸ªä»£ç†
                const nextProxyIndex = (retryCount + 1) % PROXY_LIST.length;
                const newSrc = PROXY_LIST[nextProxyIndex] + encodeURIComponent(originalUrl);
                imgElement.src = newSrc;
                imgElement.dataset.retry = nextProxyIndex;
            } else {
                // æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½å›¾
                imgElement.src = 'data:image/svg+xml,%3Csvg ... %3E';
                imgElement.alt = 'åŠ è½½å¤±è´¥';
            }
        };
        window.retryCardImage = function(cardImage) {
            const originalUrl = cardImage.dataset.original;
            let proxyIndex = parseInt(cardImage.dataset.proxyIndex || 0);
            const maxRetries = PROXY_LIST.length;

            if (proxyIndex < maxRetries - 1) {
                // å°è¯•ä¸‹ä¸€ä¸ªä»£ç†
                const nextIndex = proxyIndex + 1;
                const newSrc = PROXY_LIST[nextIndex] + encodeURIComponent(originalUrl);
                cardImage.style.backgroundImage = `url('${newSrc}')`;
                cardImage.dataset.proxyIndex = nextIndex;
            } else {
                // æ‰€æœ‰ä»£ç†å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½èƒŒæ™¯
                cardImage.style.backgroundImage = 'none';
                cardImage.style.backgroundColor = '#eee';
                cardImage.innerHTML = 'âŒ';
            }
        };
        // ğŸ”§ è¿ç§»è€æ•°æ®ï¼šå¦‚æœå¡ç‰‡ä¸­çš„å›¾ç‰‡ä¸æ˜¯ä»£ç†åœ°å€ï¼Œåˆ™åŒ…è£…ä¸€æ¬¡
        gridData.cards = gridData.cards.map(card => {
            if (card.image && !card.image.startsWith(IMAGE_PROXY) && !card.image.startsWith('data:')) {
                card.image = IMAGE_PROXY + encodeURIComponent(card.image);
            }
            return card;
        });
        const gridContainer = document.getElementById('anime-grid');
        const mainTitleInput = document.getElementById('main-title-input');
        const addAnimeBtn = document.getElementById('add-anime-btn');
        const screenshotBtn = document.getElementById('screenshot-btn');
        const layoutSelect = document.getElementById('layout-select');

        // --- åˆå§‹åŒ–æ¸²æŸ“ ---
        function init() {
            mainTitleInput.value = gridData.mainTitle;
            renderGrid();

            mainTitleInput.addEventListener('input', function(e) {
                gridData.mainTitle = e.target.value;
                save();
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰æœç´¢æ¡†
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.card')) {
                    document.querySelectorAll('.search-container').forEach(function(el) {
                        el.classList.remove('active');
                    });
                }
            });

            // æ·»åŠ ç•ªå‰§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            addAnimeBtn.addEventListener('click', function() {
                addAnime();
            });

            // æˆªå›¾ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            screenshotBtn.addEventListener('click', function() {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼ŒåŒ…å«æ ‡é¢˜å’Œç½‘æ ¼
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.top = '-9999px';
                tempContainer.style.left = '-9999px';
                tempContainer.style.padding = '50px';
                tempContainer.style.backgroundColor = '#f5f5f5';
                tempContainer.style.borderRadius = '12px';

                // åˆ›å»ºæ ‡é¢˜å…ƒç´ 
                const titleElement = document.createElement('h2');
                titleElement.style.textAlign = 'center';
                titleElement.style.marginBottom = '30px';
                titleElement.style.fontSize = '24px';
                titleElement.style.color = '#333';
                titleElement.textContent = mainTitleInput.value || '';

                // å…‹éš†ç½‘æ ¼å®¹å™¨
                const gridClone = document.querySelector("#anime-grid").cloneNode(true);

                // å°†æ ‡é¢˜å’Œç½‘æ ¼æ·»åŠ åˆ°ä¸´æ—¶å®¹å™¨
                tempContainer.appendChild(titleElement);
                tempContainer.appendChild(gridClone);

                // å°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ°æ–‡æ¡£
                document.body.appendChild(tempContainer);

                // æ‰§è¡Œ html2canvas
                html2canvas(tempContainer, {
                    useCORS: true,
                    proxy: IMAGE_PROXY, // åŠ ä¸Šè¿™ä¸€è¡Œ
                    scale: 2,
                    backgroundColor: '#f5f5f5'
                }).then(canvas => {
                    // 1. å°† canvas è½¬ä¸º base64 æ ¼å¼çš„å›¾ç‰‡åœ°å€
                    const imgData = canvas.toDataURL('image/png');

                    // 2. åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ <a> æ ‡ç­¾æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = 'my-anime-grid.png'; // ä¸‹è½½çš„æ–‡ä»¶å
                    link.click();

                    // 3. ç§»é™¤ä¸´æ—¶å®¹å™¨
                    document.body.removeChild(tempContainer);
                });
            });

            // å¸ƒå±€é€‰æ‹©äº‹ä»¶
            layoutSelect.addEventListener('change', function() {
                updateLayout(this.value);
            });
        }

        function renderGrid() {
            gridContainer.innerHTML = '';
            gridData.cards.forEach(function(data, index) {
                const card = document.createElement('div');
                card.className = 'card';
                card.draggable = true;
                card.setAttribute('data-index', index);
                card.innerHTML = `
                    <button class="delete-btn" onclick="event.stopPropagation()">Ã—</button>
                    <div class="card-image" style="background-image: url('${data.image}')">
                        ${data.image ? '' : '+'}
                    </div>
                    <div class="card-title">${data.title}</div>
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="æœç´¢ç•ªå‰§å..." onclick="event.stopPropagation()">
                        <div class="results-list"></div>
                    </div>
                `;

                // å¡ç‰‡ç‚¹å‡»é€»è¾‘
                card.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // å…³é—­å…¶ä»–
                    document.querySelectorAll('.search-container').forEach(function(el) {
                        el.classList.remove('active');
                    });
                    // å¼€å¯å½“å‰
                    const searchBox = card.querySelector('.search-container');
                    searchBox.classList.toggle('active');
                    searchBox.querySelector('.search-input').focus();
                });

                // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteAnime(index);
                });

                // æ‹–æ‹½æ’åºç›¸å…³å˜é‡
                let isDragging = false;
                let startX, startY;
                let dragIndex;
                let originalIndex;
                let startPosition;

                // é•¿æŒ‰å¯åŠ¨æ‹–æ‹½
                let longPressTimer;
                const longPressDelay = 2000; // é•¿æŒ‰å»¶è¿Ÿæ—¶é—´ï¼Œ3ç§’

                // é¼ æ ‡æŒ‰ä¸‹/è§¦æ‘¸å¼€å§‹
                function startDrag(e) {
                    e.stopPropagation();
                    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
                    clearTimeout(longPressTimer);

                    // è®¾ç½®é•¿æŒ‰è®¡æ—¶å™¨
                    longPressTimer = setTimeout(function() {
                        isDragging = true;
                        dragIndex = parseInt(card.getAttribute('data-index'));
                        originalIndex = dragIndex;
                        card.classList.add('dragging');

                        // è®°å½•åˆå§‹ä½ç½®
                        if (e.type === 'mousedown') {
                            startX = e.clientX;
                            startY = e.clientY;
                        } else {
                            startX = e.touches[0].clientX;
                            startY = e.touches[0].clientY;
                        }

                        // è®°å½•å¡ç‰‡åˆå§‹ä½ç½®
                        startPosition = card.getBoundingClientRect();
                    }, longPressDelay);
                }

                // é¼ æ ‡ç§»åŠ¨/è§¦æ‘¸ç§»åŠ¨
                function onDrag(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    // è·å–å½“å‰é¼ æ ‡/è§¦æ‘¸ä½ç½®
                    let clientX, clientY;
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    }

                    // è®¡ç®—åç§»é‡
                    const offsetX = clientX - startX;
                    const offsetY = clientY - startY;

                    // æ›´æ–°æ‹–æ‹½å¡ç‰‡ä½ç½®
                    card.style.position = 'absolute';
                    card.style.left = (startPosition.left - gridContainer.getBoundingClientRect().left + offsetX) + 'px';
                    card.style.top = (startPosition.top - gridContainer.getBoundingClientRect().top + offsetY) + 'px';
                    card.style.zIndex = '1000';
                    card.style.pointerEvents = 'none'; // é˜²æ­¢æ‹–æ‹½æ—¶è§¦å‘å…¶ä»–äº‹ä»¶

                    // æ£€æµ‹ç¢°æ’ï¼Œæ‰¾åˆ°ç›®æ ‡å¡ç‰‡
                    const cards = Array.from(gridContainer.children);
                    let closestCard = null;
                    let minDistance = Infinity;
                    let insertPosition = 'after';

                    // è®¡ç®—ä¸æ¯ä¸ªå¡ç‰‡çš„è·ç¦»
                    cards.forEach(function(otherCard, otherIndex) {
                        if (otherCard !== card) {
                            const rect = otherCard.getBoundingClientRect();
                            // è®¡ç®—å¡ç‰‡ä¸­å¿ƒåæ ‡
                            const cardCenterX = rect.left + rect.width / 2;
                            const cardCenterY = rect.top + rect.height / 2;

                            // è®¡ç®—è·ç¦»
                            const distance = Math.sqrt(
                                Math.pow(clientX - cardCenterX, 2) +
                                Math.pow(clientY - cardCenterY, 2)
                            );

                            // æ‰¾åˆ°æœ€è¿‘çš„å¡ç‰‡
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestCard = otherCard;
                                // ç¡®å®šæ’å…¥ä½ç½®
                                insertPosition = clientY < cardCenterY ? 'before' : 'after';
                            }
                        }
                    });

                    // æ›´æ–°DOMç»“æ„
                    if (closestCard) {
                        // ç§»é™¤å½“å‰å¡ç‰‡
                        card.parentNode.removeChild(card);
                        // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
                        if (insertPosition === 'before') {
                            gridContainer.insertBefore(card, closestCard);
                        } else {
                            gridContainer.insertBefore(card, closestCard.nextSibling);
                        }
                        // æ›´æ–°ç´¢å¼•
                        updateCardIndices();
                    }
                }

                // é¼ æ ‡é‡Šæ”¾/è§¦æ‘¸ç»“æŸ
                function endDrag(e) {
                    e.stopPropagation();
                    // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                    clearTimeout(longPressTimer);

                    if (isDragging) {
                        isDragging = false;
                        card.classList.remove('dragging');

                        // é‡ç½®å¡ç‰‡æ ·å¼
                        card.style.position = '';
                        card.style.left = '';
                        card.style.top = '';
                        card.style.zIndex = '';
                        card.style.pointerEvents = '';

                        // è·å–æœ€ç»ˆä½ç½®çš„ç´¢å¼•
                        const cards = Array.from(gridContainer.children);
                        const finalIndex = cards.indexOf(card);

                        // å¦‚æœä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æ•°æ®
                        if (finalIndex !== originalIndex) {
                            const draggedCard = gridData.cards.splice(originalIndex, 1)[0];
                            gridData.cards.splice(finalIndex, 0, draggedCard);
                            save();
                        }

                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼ï¼Œæ¢å¤æ­£å¸¸çŠ¶æ€
                        renderGrid();
                    }
                }

                // æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„ç´¢å¼•
                function updateCardIndices() {
                    const cards = Array.from(gridContainer.children);
                    cards.forEach(function(card, index) {
                        card.setAttribute('data-index', index);
                    });
                }

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                // é¼ æ ‡äº‹ä»¶
                card.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', endDrag);

                // è§¦æ‘¸äº‹ä»¶ï¼ˆæ‰‹æœºç«¯æ”¯æŒï¼‰
                card.addEventListener('touchstart', startDrag, {
                    passive: false
                });
                document.addEventListener('touchmove', onDrag, {
                    passive: false
                });
                document.addEventListener('touchend', endDrag);

                // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
                card.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                });

                // æœç´¢è¾“å…¥é€»è¾‘ (é˜²æŠ–)
                const searchInput = card.querySelector('.search-input');
                const resultsList = card.querySelector('.results-list');
                let debounceTimer;

                searchInput.addEventListener('input', function(e) {
                    clearTimeout(debounceTimer);
                    const query = e.target.value.trim();
                    if (!query) {
                        resultsList.innerHTML = '';
                        return;
                    }

                    debounceTimer = setTimeout(function() {
                        performSearch(query, resultsList, index);
                    }, 500);
                });

                gridContainer.appendChild(card);
            });
        }

        // --- æ ¸å¿ƒæœç´¢é€»è¾‘ ---
        function performSearch(query, resultsList, cardIndex) {
            resultsList.innerHTML = '<div class="loading-text">æ­£åœ¨ä» AniList & Bangumi æœç´¢...</div>';

            // 1. æœ¬åœ°æ¨¡ç³ŠåŒ¹é…
            const localMatches = LOCAL_PRESETS.filter(function(item) {
                return item.title.toLowerCase().includes(query.toLowerCase());
            });

            // 2. AniList API (GraphQL)
            const aniListQuery = `
                query ($search: String) {
                    Page(perPage: 10) {
                        media(search: $search, type: ANIME) {
                            title { romaji chinese: english }
                            coverImage { large }
                        }
                    }
                }
            `;

            const aniListPromise = fetch('https://graphql.anilist.co', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: aniListQuery,
                    variables: {
                        search: query
                    }
                })
            }).then(function(res) {
                return res.json();
            }).catch(function() {
                return null;
            });

            // 3. Bangumi API (REST)
            const bgmPromise = fetch(`https://api.bgm.tv/search/subject/${encodeURIComponent(query)}?type=2`)
                .then(function(res) {
                    return res.json();
                }).catch(function() {
                    return null;
                });

            // ç­‰å¾…æ‰€æœ‰ç»“æœ
            Promise.all([aniListPromise, bgmPromise]).then(function([aniRes, bgmRes]) {
                // 4. åˆå¹¶å¹¶å»é‡
                let combined = localMatches.slice();

                if (aniRes && aniRes.data && aniRes.data.Page && aniRes.data.Page.media) {
                    aniRes.data.Page.media.forEach(function(m) {
                        combined.push({
                            title: m.title.romaji || m.title.chinese,
                            image: m.coverImage.large
                        });
                    });
                }

                if (bgmRes && bgmRes.list) {
                    bgmRes.list.slice(0, 10).forEach(function(m) {
                        combined.push({
                            title: m.name_cn || m.name,
                            image: m.images && m.images.large ? m.images.large : ""
                        });
                    });
                }

                // å»é‡
                const uniqueResults = combined.filter(function(v, i, a) {
                    return a.findIndex(function(t) {
                        return t.title === v.title;
                    }) === i;
                });

                // 5. æ¸²æŸ“åˆ—è¡¨
                renderResults(uniqueResults, resultsList, cardIndex);

            }).catch(function(error) {
                resultsList.innerHTML = '<div class="loading-text">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            });
        }

        function renderResults(results, container, cardIndex) {
            container.innerHTML = '';
            if (results.length === 0) {
                container.innerHTML = '<div class="loading-text">æœªæ‰¾åˆ°ç»“æœ</div>';
                return;
            }

            results.forEach(function(item) {
                const li = document.createElement('li');
                li.className = 'result-item';
                const imgUrl = proxyImage(item.image);
                li.innerHTML = `
            <img src="${imgUrl}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'56\' viewBox=\'0 0 40 56\'%3E%3Crect width=\'40\' height=\'56\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' fill=\'%23999\' font-size=\'10\'%3Eæ— å›¾%3C/text%3E%3C/svg%3E'">
            <span>${item.title}</span>
        `;
                li.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectAnime(cardIndex, item);
                });
                container.appendChild(li);
            });
            results.forEach(function(item) {
                const li = document.createElement('li');
                li.className = 'result-item';
                // å…ˆä½¿ç”¨å½“å‰é»˜è®¤ä»£ç†ç”Ÿæˆå›¾ç‰‡URL
                const imgUrl = proxyImage(item.image);
                li.innerHTML = `
            <img src="${imgUrl}" 
                 data-original="${item.image}"
                 data-retry="0"
                 onerror="retryWithNextProxy(this)"
                 onload="this.style.display='block'">
            <span>${item.title}</span>
        `;
                li.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectAnime(cardIndex, item);
                });
                container.appendChild(li);
            });
        }

        // --- é€‰æ‹©ä¸ä¿å­˜ ---
        function selectAnime(index, item) {
            // ä¿å­˜æ—¶åŒæ—¶ä¿å­˜åŸå§‹åœ°å€å’Œå½“å‰ä½¿ç”¨çš„ä»£ç†ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰
            const proxyIndex = currentProxyIndex;
            const proxiedImage = proxyImage(item.image, proxyIndex);
            gridData.cards[index] = {
                title: item.title,
                image: proxiedImage,
                originalImage: item.image, // æ–°å¢ï¼šä¿å­˜åŸå§‹åœ°å€
                proxyIndex: proxyIndex // æ–°å¢ï¼šä¿å­˜ä½¿ç”¨çš„ä»£ç†ç´¢å¼•
            };
            save();

            const card = gridContainer.children[index];
            if (card) {
                const cardImage = card.querySelector('.card-image');
                const cardTitle = card.querySelector('.card-title');

                // æ›´æ–°èƒŒæ™¯å›¾ï¼Œå¹¶æ·»åŠ  data-* å±æ€§ä»¥ä¾¿é‡è¯•
                cardImage.style.backgroundImage = `url('${proxiedImage}')`;
                cardImage.dataset.original = item.image;
                cardImage.dataset.proxyIndex = proxyIndex;
                cardImage.onerror = function() {
                    retryCardImage(this);
                };

                cardImage.innerHTML = proxiedImage ? '' : '+';
                cardTitle.textContent = item.title;

                const searchBox = card.querySelector('.search-container');
                searchBox.classList.remove('active');
            }
        }

        // --- æ·»åŠ ç•ªå‰§åŠŸèƒ½ ---
        function addAnime() {
            // å‘cardsæ•°ç»„æ·»åŠ ä¸€ä¸ªæ–°çš„å¡ç‰‡å¯¹è±¡
            gridData.cards.push({
                title: "ç‚¹å‡»é€‰æ‹©ç•ªå‰§",
                image: ""
            });
            // ä¿å­˜æ•°æ®
            save();
            // é‡æ–°æ¸²æŸ“ç½‘æ ¼
            renderGrid();
        }

        // --- å¸ƒå±€æ›´æ–°åŠŸèƒ½ ---
        function updateLayout(layoutType) {
            if (layoutType === 'auto') {
                // ç§»é™¤å†…è”æ ·å¼ï¼Œä½¿ç”¨CSSä¸­çš„å“åº”å¼å¸ƒå±€
                gridContainer.style.gridTemplateColumns = '';
                gridContainer.style.gap = '';
            } else if (layoutType === '3x3') {
                // å¼ºåˆ¶ä½¿ç”¨3x3å¸ƒå±€
                gridContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
                gridContainer.style.gap = '20px';
            } else if (layoutType === '2x2') {
                // å¼ºåˆ¶ä½¿ç”¨2x2å¸ƒå±€
                gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                gridContainer.style.gap = '20px';
            } else if (layoutType === '4x3') {
                // å¼ºåˆ¶ä½¿ç”¨4x3å¸ƒå±€
                gridContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
                gridContainer.style.gap = '15px';
            } else if (layoutType === '5x2') {
                // å¼ºåˆ¶ä½¿ç”¨5x2å¸ƒå±€
                gridContainer.style.gridTemplateColumns = 'repeat(5, 1fr)';
                gridContainer.style.gap = '10px';
            }
        }

        // --- åˆ é™¤ç•ªå‰§åŠŸèƒ½ ---
        function deleteAnime(index) {
            // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªå¡ç‰‡
            if (gridData.cards.length > 1) {
                // ä»cardsæ•°ç»„ä¸­åˆ é™¤æŒ‡å®šç´¢å¼•çš„å¡ç‰‡
                gridData.cards.splice(index, 1);
                // ä¿å­˜æ•°æ®
                save();
                // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                renderGrid();
            }
        }

        function save() {
            localStorage.setItem('animeGridData', JSON.stringify(gridData));
        }

        // å¯åŠ¨
        init();
    </script>

    <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #666; padding-bottom: 20px;">
        ç•ªå‰§æ¨èè¡¨ åˆ¶ä½œï¼šMorlvoid/fulie ï¼ˆæœ¬è¡¨ä¸ºæœ¬åœ°å‚¨å­˜ï¼Œä¸æ”¶é›†ä»»ä½•ç”¨æˆ·ä¿¡æ¯ï¼‰
    </div>
</body>

</html>